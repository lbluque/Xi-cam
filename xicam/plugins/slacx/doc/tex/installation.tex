\chapter{installation}
\label{ch:installation}

Instructions will go here for installing \verb|slacx| using 
the Python pacakage installer \verb|pip|,
as soon as the \verb|slacx| package is prepared for that.
Currently, installation from \verb|pip| is not implemented.
Users looking to install \verb|slacx| from source
should build a virtual environment (optional),
install the dependencies listed in section~\ref{subsec:dependencies},
and invoke the \verb|main.py| module in the \verb|slacx| top-level directory.
Soon, this will be better.


\chapter{system setup}
\label{ch:system_setup}
\lstset{language=Bash}

Successful building of \verb|slacx| depends on a few trusty, stable packages.
Developers should take care to favor a stable and cross-platform utility
over a fancier option, in order to keep installation of \verb|slacx| fast and easy.
This section walks through some of the finer points 
of setting up a computer to develop code for \verb|slacx| 
or run \verb|slacx| from source.


\section{system dependencies}

The packages described in this section 
may already be prepared on your operating system.
If you have already used \verb|pip| to install packages before,
you can probably skip this section entirely
and move on to section~\ref{subsec:virtualenv}.


\subsection{pip, setuptools, and wheel}

\verb|pip| is a Python package manager
(acronym: \verb|pip| Installs Python). 
There are other ways to install packages, but for now
this documentation will cover the usage of \verb|pip|.
\verb|setuptools| is a Python library that supports
many of the operations performed in this section.
\verb|wheel| is a package distribution and installation library 
supporting the \verb|wheel| distribution standard.
Users will typically want to install these together.

\verb|pip|, \verb|setuptools|, and \verb|wheel| are installed by default 
on many Linux distributions and OSX, but should be upgraded.
Enterprise Linux (e.g. RHEL, CentOS, SL, OL) are the exception.
Enterprise Linux users should skip ahead 
to section~\ref{subsec:setup_rhel}.
For other Linux distributions (Fedora, Ubuntu, etc.)
it is suggested that the user employ the system's package manager 
(skip ahead to section~\ref{subsec:setup_non-enterprise}),
though the user may choose instead 
to use \verb|pip| to upgrade itself, as shown below.

Perform the upgrade by typing:
\begin{lstlisting}
pip install -U pip setuptools
\end{lstlisting}


\subsection{pip, wheel, and setuptools for non-Enterprise Linux}
\label{subsec:setup_non-enterprise}

The instructions differ for the various distributions.
The commands listed here are copied 
from the web at \verb|https://packaging.python.org/|.
Enter the commands in a terminal, 
as listed for your particular distribution.
If your distribution is not covered here, 
please consider adding its instructions to the docs
and submitting a pull request.

\begin{itemize}
\item Fedora 21: 
    \begin{lstlisting}
    sudo yum upgrade python-setuptools
    sudo yum install python-pip python-wheel
    \end{lstlisting}
\item Fedora 22: 
    \begin{lstlisting}
    sudo dnf upgrade python-setuptools
    sudo dnf install python-pip python-wheel
    \end{lstlisting}
\item Debian/Ubuntu: 
    \begin{lstlisting}
    sudo apt-get install python-setuptools python-pip python-wheel
    \end{lstlisting}
\end{itemize}


\subsection{pip, wheel, and setuptools for Enterprise Linux}
\label{subsec:setup_rhel}

\textit{tested on RHEL 6.8 (Santiago)}

\subsubsection{adding the EPEL repository}

NOTE: You may already have connection to the \verb|EPEL| repository.
You can tell if you have \verb|EPEL| connected by entering:
\begin{lstlisting}
sudo yum repolist all
\end{lstlisting}
Look through the list, 
under the \verb|repo name| heading,
for a repo named \verb|EPEL|.
If you have it, skip ahead to section~\ref{subsubsec:pip_from_epel}.

The easiest way to maintain \verb|pip|, \verb|setuptools|, and \verb|wheel|
is to enable the \verb|EPEL| repository (Extra Packages for Enterprise Linux)
for your particular distribution.
The \verb|EPEL| SIG (Special Interest Group) 
maintains \verb|rpm| installers that add \verb|EPEL| 
to RHEL's \verb|yum| repository list.
Begin by downloading this installer
and running it with \verb|rpm|.

These instructions assume you are using RHEL6,
where the \verb|EPEL| installer will be 
\verb|epel-release-latest-6.noarch.rpm|.
For other Enterprise Linux distributions,
check the web at \verb|https://fedoraproject.org/wiki/EPEL|
for the correct \verb|EPEL| installer file,
and replace \verb|epel-release-latest-6.noarch.rpm|
in the following instructions with the appropriate filename.
\begin{lstlisting}
wget https://dl.fedoraproject.org/pub/epel/epel-release-latest-6.noarch.rpm
rpm -i epel-release-latest-6.noarch.rpm  
\end{lstlisting}
These commands should enable \verb|EPEL|.


\subsubsection{installing pip from EPEL}
\label{subsubsec:pip_from_epel}

\verb|pip| is one (important) package that can be obtained from \verb|EPEL|.
In many cases, \verb|pip| can be obtained simply by running:
\begin{lstlisting}
sudo yum install python-pip
\end{lstlisting}
In some cases, the \verb|python-pip| package will not be found.
One possibility is that the package will have a different name
in the user's specific set of repositories.
The next thing to try is:
\begin{lstlisting}
sudo yum install python27-python-pip
\end{lstlisting}
If this doesn't work, 
the user must find a package that provides \verb|pip|.
Try the following:
\begin{lstlisting}
sudo yum whatprovides *python-pip*
\end{lstlisting}
This may return a package name like \newline 
\verb|python27-python-pip-1.5.6-5.el6.noarch|.
Try directly installing that package:
\begin{lstlisting}
sudo yum install python27-python-pip-1.5.6-5.el6.noarch
\end{lstlisting}

Once \verb|pip| has been installed, it should be used 
to install or upgrade \verb|wheel| and \verb|setuptools|.
With a friendly configuration, the following will work:
\begin{lstlisting}
sudo pip install --upgrade setuptools 
sudo pip install --upgrade wheel 
\end{lstlisting}

If these throw errors, for example,
\begin{lstlisting}
error while loading shared libraries: libpython2.7.so.1.0: cannot open shared object file: No such file or directory
\end{lstlisting}
the user will have to locate that shared library 
and add its location to their \verb|LD_LIBRARY_PATH| environment variable.
One way to locate the library is to ask \verb|yum| to find it:
\begin{lstlisting}
yum whatprovides *libpython2.7*
\end{lstlisting}
may produce something like:
\begin{lstlisting}
python27-python-libs-ver.rel.arch : Runtime libraries for Python
Repo        : installed
Matched from:
Filename    : /path/to/libpython2.7.so.1.0
\end{lstlisting}
The search will also probably bring up some development and debugging libraries:
\begin{lstlisting}
python27-python-devel-2.7.8-3.el6.x86_64 : The libraries and header files needed for Python development
Repo        : <repo-name> 
Matched from:
Filename    : /opt/rh/python27/root/usr/lib64/libpython2.7.so
Filename    : /opt/rh/python27/root/usr/lib64/python2.7/config/libpython2.7.so
\end{lstlisting}
and:
\begin{lstlisting}
python27-python-debug-2.7.8-3.el6.x86_64 : Debug version of the Python runtime
Repo        : <repo-name> 
Matched from:
Filename    : /opt/rh/python27/root/usr/lib64/libpython2.7_d.so
Filename    : /opt/rh/python27/root/usr/lib64/libpython2.7_d.so.1.0
Filename    : /opt/rh/python27/root/usr/share/systemtap/tapset/libpython2.7-debug-64.stp
Other       : libpython2.7_d.so.1.0()(64bit)
\end{lstlisting}
The package that needs to be installed in each case 
(to get the required library)
is named in the top line of each block.
You might as well install any of these
that are not already installed
(note that \verb|python27-python-libs-ver.rel.arch|
is already marked as installed in this case).
Install the debug and development libraries if necessary:
\begin{lstlisting}
sudo yum install python27-python-debug-2.7.8-3.el6.x86_64
sudo yum install python27-python-devel-2.7.8-3.el6.x86_64
\end{lstlisting}

The path of the shared object is the line following the \verb|Filename:| label.
Take that line and place it in your \verb|LD_LIBRARY_PATH| 
by adding to your shell configuration file, 
e.g. for \verb|~/.bashrc|:
\begin{lstlisting}
echo `export LD_LIBRARY_PATH=/dir/with/libpython/:$LD_LIBRARY_PATH' >> ~/.bashrc
source ~/.bashrc
\end{lstlisting}
%stopzone

With this done, try again to install/upgrade \verb|setuptools| and \verb|wheel|:
\begin{lstlisting}
sudo pip install --upgrade setuptools 
sudo pip install --upgrade wheel 
\end{lstlisting}
If this doesn't work, try setting up \verb|sudo| to preserve your \verb|LD_LIBRARY_PATH|:
\begin{lstlisting}
echo "alias ldsudo=`sudo LD_LIBRARY_PATH=$LD_LIBRARY_PATH'" >> ~/.bashrc
export ~/.bashrc
\end{lstlisting}
%stopzone

Now, try again in install/upgrade \verb|setuptools| and \verb|wheel|,
but this time use \verb|ldsudo|.
If it doesn't work, ask your sysadmin for help.
Once these are done, some additional steps are needed
to prepare the system for \verb|Qt| applications.
Read on, section~\ref{subsubsec:pyside_linux}


\subsubsection{preparing PySide Qt on Linux}
\label{subsubsec:pyside_linux}

Since \verb|slacx| is built on the \verb|Qt| platform 
(via \verb|PySide| bindings),
a few more system libraries are needed.
\verb|Qt| itself is written in C++
and uses C extensions,
so C++ and C compilers will be needed.
These compilers will be used with the 
cross-platform \verb|cmake| utility,
and \verb|Qt| makes extensive use of the \verb|qmake| tool.
This section guides you through the installation of these libraries.

\begin{enumerate}
\item 
Check for existing C and C++ compilers:
\begin{lstlisting}
which cc
which c++
\end{lstlisting}
If the system has no \verb|cc| or \verb|c++|,
find them with 
\begin{lstlisting}
yum whatprovides *bin/cc
yum whatprovides *bin/c++
\end{lstlisting}
A list of compiler and developer suites, 
for example various \verb|devtoolset| versions, will come up.
Take a minute to find
the latest and most general version.
Take note of the package name and the directory containing the binaries.
Install the package and add the directory for the compiler binaries to your path.
\begin{lstlisting}
sudo yum install devtoolset-<latest-versoin>-gcc.x86_64 
echo `export PATH=/opt/rh/devtoolset-4/root/usr/bin/:$PATH' >> ~/.bashrc
\end{lstlisting}
%stopzone

\item 
Repeat this process for \verb|qmake|, which will come with other \verb|Qt| utilities.
\begin{lstlisting}
yum whatprovides *bin/qmake
sudo yum install qt-devel-4.6.2-28.el6_5.x86_64 
echo `export PATH=/usr/lib64/qt4/bin/:$PATH' >> ~/.bashrc
\end{lstlisting}
%stopzone

\item 
Repeat this process for \verb|cmake|. 
For \verb|cmake|, no \verb|$PATH| modifications should be needed.
\begin{lstlisting}
yum whatprovides *bin/cmake
sudo yum install cmake-2.8.12.2-4.el6.x86_64 
\end{lstlisting}

\end{enumerate}


\subsection{setting up a virtual environment with virtualenv}
\label{subsec:virtualenv}

At this point, it is assumed the user has working installations of
\verb|pip|, \verb|wheel|, and \verb|setuptools|.
This will be the default case for many systems.
Users familiar with \verb|virtualenv| may choose to skip this section.

Building software in a virtual environment is suggested 
as a way of sandboxing libraries that are used by other system components.
After setting up \verb|pip|, \verb|setuptools|, and \verb|wheel| (above),
the installation and setup of a virtual environment is easy.

Begin by installing \verb|virtualenv|:
\begin{lstlisting}
sudo pip install virtualenv
\end{lstlisting}

Now, assuming you want to store the \verb|slacx| virtual environment
in directory \verb|<dir>|,
execute the following in a terminal
\begin{lstlisting}
mkdir <dir> 
virtualenv <dir>
source <dir>/bin/activate
# To terminate virtualenv session:
deactivate
\end{lstlisting}

With the virtual environment active,
Python packages can be installed without \verb|sudo|
and will only affect the package space of the virtual environment.
Any packages installed in the virtual environment are effectively invisible
once the virtual environment is turned off by calling \verb|deactivate|.


\subsection{installing python dependencies}
\label{subsec:dependencies}

After installing the system packages and starting a virtual environment (above),
the installation of the necessary Python packages should be easy.
Ensure the virtual environment is active
(you should see the name of the virtual environment 
in parentheses to the left of the command prompt),
then install each of these packages by \verb|pip install <packagename>|.
Some of these may take a few minutes to install (\verb|scipy| for example).
Be patient, make some coffee, \verb|pip| will probably eventually finish.

NOTE: If you are installing \verb|slacx| 
from a wheel-compatible distribution, 
the dependencies will be handled automatically,
so there is no need to do this.

\begin{itemize}
\item \verb|numpy|: Python numerical computation library
\item \verb|scipy|: Python scientific math library
\item \verb|PySide|: Python \verb|Qt| bindings library: 
    Some Linux distributions may need to go through section~\ref{subsubsec:pyside_linux} above
    before this installs nicely.
\item \verb|fabio|: Fable I/O library, parses image files from common CCD array detectors devices
\item \verb|pyFAI|: Fast Azimuthal Integration library for reducing image data
\item \verb|h5py|: Library for manipulating files of the fast-readable hdf5 format
%\item \verb|PyOpenGL|: Python bindings for OpenGL graphics library
%\item \verb|PyOpenCL|: Python bindings for the OpenCL parallel computing framework
%\item \verb|PyYAML|: Python library for YAML serialization language 
%\item \verb|qtconsole|: A terminal for executing python code including inline Qt figures
\item \verb|PyQtGraph|: Scientific visualization library built on PyQt4/PySide
\item \verb|matplotlib|: Highly versatile plotting library 
\item \verb|lxml|: XML and HTML parsing library 
\item \verb|QDarkStyle|: A dark stylesheet for the Qt GUI- your eyes will be happier
\item \verb|pillow|: A replacement for the outdated Python Imaging Library (PIL)
\end{itemize}



